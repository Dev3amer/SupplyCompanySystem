<UserControl x:Class="SupplyCompanySystem.UI.Views.InvoicesView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Background="White"
             FlowDirection="RightToLeft">

    <UserControl.Resources>
        <Style x:Key="TopBarButtonStyle" TargetType="Button">
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Margin" Value="0,0,5,0"/>
            <Setter Property="Visibility" Value="Collapsed"/>
        </Style>

        <!-- ✅ ستايل لـ TextBox البحث -->
        <Style x:Key="SearchTextBoxStyle" TargetType="TextBox">
            <Setter Property="Padding" Value="8"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Background" Value="#F8F9FA"/>
            <Setter Property="BorderBrush" Value="#E0E0E0"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Margin" Value="0,0,0,8"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Top Bar with Buttons -->
        <Border Grid.Row="0" Background="#F8F9FA" Padding="15" BorderThickness="0,0,0,1" BorderBrush="#E0E0E0">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">

                <Button Content="+ فاتورة جديدة" Command="{Binding NewInvoiceCommand}" Background="#27AE60">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource TopBarButtonStyle}">
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding IsEditMode}" Value="False"/>
                                        <Condition Binding="{Binding IsSaved}" Value="False"/>
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Visible"/>
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <Button Content="حفظ" Command="{Binding SaveInvoiceCommand}" Background="#2ECC71">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource TopBarButtonStyle}">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsEditMode}" Value="True">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <Button Content="✎ تعديل" Command="{Binding EditInvoiceCommand}" Background="#F39C12">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource TopBarButtonStyle}">
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding IsEditMode}" Value="False"/>
                                        <Condition Binding="{Binding IsSaved}" Value="True"/>
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Visible"/>
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <Button Content="إكمال الفاتورة" Command="{Binding CompleteInvoiceCommand}" Background="#3498DB">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource TopBarButtonStyle}">
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding IsEditMode}" Value="False"/>
                                        <Condition Binding="{Binding IsSaved}" Value="True"/>
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Visible"/>
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <Button Content="إلغاء" Command="{Binding CancelCommand}" Background="#95A5A6">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource TopBarButtonStyle}">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsEditMode}" Value="True">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding IsSaved}" Value="True">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
            </StackPanel>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3*"/>
                <ColumnDefinition Width="1*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Side - Invoice Details -->
            <Border Grid.Column="0" Padding="15">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Customer and Profit Margin Row -->
                    <Grid Grid.Row="0" Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="1*"/>
                            <ColumnDefinition Width="1*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Customer Selection with Search -->
                        <StackPanel Grid.Column="0" Margin="0,0,5,0">
                            <TextBlock Text="اختر العميل:" Foreground="#2C3E50" FontSize="14" FontWeight="Bold" Margin="0,0,0,8"/>

                            <!-- ✅ TextBox للبحث في العملاء -->
                            <TextBox Text="{Binding CustomerSearchText, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource SearchTextBoxStyle}"
                                     IsEnabled="{Binding IsEditMode}">
                                <TextBox.InputBindings>
                                    <KeyBinding Key="Esc" Command="{Binding ClearCustomerSearchCommand}"/>
                                </TextBox.InputBindings>
                            </TextBox>

                            <!-- ✅ ComboBox يعرض العملاء المفلترين -->
                            <ComboBox ItemsSource="{Binding FilteredCustomers}" 
                                      SelectedItem="{Binding SelectedCustomer}"
                                      DisplayMemberPath="Name"
                                      Padding="8"
                                      IsEnabled="{Binding IsEditMode}"
                                      MaxDropDownHeight="200"/>
                        </StackPanel>

                        <!-- Profit Margin Percentage -->
                        <StackPanel Grid.Column="1" Margin="5,0,0,0">
                            <TextBlock Text="نسبة المكسب %:" FontSize="14" FontWeight="Bold" Margin="0,0,0,8" Foreground="#27AE60"/>
                            <TextBox Padding="8" 
                                     Text="{Binding ProfitMarginPercentage, UpdateSourceTrigger=PropertyChanged}"
                                     IsEnabled="{Binding IsEditMode}"
                                     Foreground="#27AE60"
                                     FontWeight="Bold">
                                <TextBox.Style>
                                    <Style TargetType="TextBox">
                                        <Setter Property="Background" Value="White"/>
                                    </Style>
                                </TextBox.Style>
                            </TextBox>
                        </StackPanel>
                    </Grid>

                    <!-- Product Addition Row -->
                    <Grid Grid.Row="1" Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="1*"/>
                            <ColumnDefinition Width="1*"/>
                            <ColumnDefinition Width="1*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Product Selection with Search -->
                        <StackPanel Grid.Column="0" Margin="0,0,5,0">
                            <TextBlock Text="المنتج:" FontSize="12" Margin="0,0,0,5"/>

                            <!-- ✅ TextBox للبحث في المنتجات -->
                            <TextBox Text="{Binding ProductSearchText, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource SearchTextBoxStyle}"
                                     IsEnabled="{Binding IsEditMode}">
                                <TextBox.InputBindings>
                                    <KeyBinding Key="Esc" Command="{Binding ClearProductSearchCommand}"/>
                                </TextBox.InputBindings>
                            </TextBox>

                            <!-- ✅ ComboBox يعرض المنتجات المفلترة -->
                            <ComboBox ItemsSource="{Binding FilteredProducts}" 
                                      SelectedItem="{Binding SelectedProduct}"
                                      DisplayMemberPath="Name" 
                                      Padding="8"
                                      IsEnabled="{Binding IsEditMode}"
                                      MaxDropDownHeight="200"/>
                        </StackPanel>

                        <!-- Quantity -->
                        <StackPanel Grid.Column="1" Margin="5,0,5,0">
                            <TextBlock Text="الكمية:" FontSize="12" Margin="0,0,0,5"/>
                            <TextBox Padding="8" 
                                     Text="{Binding ProductQuantity, UpdateSourceTrigger=PropertyChanged}"
                                     IsEnabled="{Binding IsEditMode}"/>
                        </StackPanel>

                        <!-- Discount -->
                        <StackPanel Grid.Column="2" Margin="5,0,5,0">
                            <TextBlock Text="الخصم %:" FontSize="12" Margin="0,0,0,5"/>
                            <TextBox Padding="8" 
                                     Text="{Binding ProductDiscount, UpdateSourceTrigger=PropertyChanged}"
                                     IsEnabled="{Binding IsEditMode}"/>
                        </StackPanel>

                        <!-- Add Button -->
                        <Button Grid.Column="3" Content="إضافة" Command="{Binding AddItemCommand}" 
                                Background="#3498DB" Foreground="White" Padding="15,8" 
                                VerticalAlignment="Bottom" BorderThickness="0" IsEnabled="{Binding IsEditMode}"/>
                    </Grid>

                    <!-- Invoice Items Header -->
                    <Grid Grid.Row="2" VerticalAlignment="Top" Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="بنود الفاتورة:" Foreground="#2C3E50" FontSize="13" FontWeight="Bold"/>
                        <Button Grid.Column="1" Content="🗑️ حذف" Command="{Binding DeleteItemCommand}" 
                                Background="#E74C3C" Foreground="White" Padding="8,5" FontSize="11" 
                                BorderThickness="0" IsEnabled="{Binding IsEditMode}"/>
                    </Grid>

                    <!-- Invoice Items DataGrid -->
                    <DataGrid Grid.Row="3" ItemsSource="{Binding InvoiceItems}" 
                              SelectedItem="{Binding SelectedInvoiceItem}"
                              AutoGenerateColumns="False" RowHeight="32" SelectionMode="Single"
                              CanUserAddRows="False" Margin="0,30,0,10" VerticalScrollBarVisibility="Visible">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="المنتج" Binding="{Binding Product.Name}" Width="150" IsReadOnly="True"/>
                            <DataGridTextColumn Header="الكمية" Binding="{Binding Quantity, UpdateSourceTrigger=PropertyChanged}" Width="80"/>
                            <DataGridTextColumn Header="الوحدة" Binding="{Binding Product.Unit}" Width="80" IsReadOnly="True"/>
                            <DataGridTextColumn Header="السعر" Binding="{Binding UnitPrice, StringFormat=N2}" Width="100" IsReadOnly="True"/>
                            <DataGridTextColumn Header="الخصم %" Binding="{Binding DiscountPercentage, UpdateSourceTrigger=PropertyChanged}" Width="80"/>
                            <DataGridTextColumn Header="الإجمالي" Binding="{Binding LineTotal, StringFormat=N2}" Width="120" IsReadOnly="True"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <!-- Remove Last Item Button -->
                    <Button Grid.Row="4" Content="حذف آخر بند" Command="{Binding RemoveItemCommand}" 
                            Background="#C0392B" Foreground="White" Padding="12,8" BorderThickness="0" 
                            IsEnabled="{Binding IsEditMode}"/>
                </Grid>
            </Border>

            <!-- Right Side - Summary -->
            <Border Grid.Column="1" Background="#F8F9FA" Padding="15" BorderThickness="1,0,0,0" BorderBrush="#E0E0E0">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <TextBlock Text="ملخص الفاتورة" FontSize="15" FontWeight="Bold" Margin="0,0,0,15" TextAlignment="Center"/>

                        <!-- Profit Margin Display in Summary -->
                        <Border Background="#E8F5E9" CornerRadius="4" Padding="8" Margin="0,0,0,15">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="نسبة المكسب:" FontSize="12" FontWeight="Bold" Foreground="#27AE60"/>
                                <TextBlock Grid.Column="1" Text="{Binding ProfitMarginPercentage, StringFormat=N2}" 
                                           FontSize="12" FontWeight="Bold" Foreground="#27AE60"/>
                            </Grid>
                        </Border>

                        <!-- Totals Grid -->
                        <Grid Margin="0,0,0,15">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Row="0" Text="إجمالي الفاتورة:"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding TotalBeforeDiscount, StringFormat=N2}" FontWeight="Bold"/>

                            <TextBlock Grid.Row="1" Text="إجمالي الخصم:" Margin="0,8,0,0"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding TotalDiscount, StringFormat=N2}" FontWeight="Bold" Margin="0,8,0,0"/>

                            <TextBlock Grid.Row="2" Text="الإجمالي النهائي:" Foreground="#27AE60" FontWeight="Bold" Margin="0,8,0,0"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding FinalAmountCalculated, StringFormat=N2}" Foreground="#27AE60" FontWeight="Bold" Margin="0,8,0,0"/>
                        </Grid>

                        <!-- Notes -->
                        <TextBlock Text="ملاحظات:" FontSize="11" Margin="0,10,0,5"/>
                        <TextBox Text="{Binding CurrentInvoice.Notes, UpdateSourceTrigger=PropertyChanged}" 
                                 Height="80" TextWrapping="Wrap" AcceptsReturn="True" IsEnabled="{Binding IsEditMode}"/>

                        <!-- Status -->
                        <Border Background="#ECF0F1" CornerRadius="4" Padding="8" Margin="0,10,0,0">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="الحالة: " FontSize="11"/>
                                <TextBlock Text="{Binding CurrentInvoice.Status}" Foreground="#3498DB" FontWeight="Bold"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- Bottom - Incomplete Invoices -->
        <Border Grid.Row="2" Background="#F8F9FA" Padding="15" BorderThickness="0,1,0,0" BorderBrush="#E0E0E0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="150"/>
                </Grid.RowDefinitions>
                <TextBlock Grid.Row="0" Text="الفواتير الغير مكتملة" FontWeight="Bold" Margin="0,0,0,10" HorizontalAlignment="Right"/>
                <Grid Grid.Row="1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Invoices DataGrid -->
                    <DataGrid ItemsSource="{Binding Invoices}" SelectedItem="{Binding SelectedInvoiceFromList}"
                              AutoGenerateColumns="False" CanUserAddRows="False" IsReadOnly="True">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="رقم" Binding="{Binding Id}" Width="60"/>
                            <DataGridTextColumn Header="العميل" Binding="{Binding Customer.Name}" Width="120"/>
                            <DataGridTextColumn Header="التاريخ" Binding="{Binding InvoiceDate, StringFormat=yyyy-MM-dd}" Width="110"/>
                            <DataGridTextColumn Header="الإجمالي" Binding="{Binding FinalAmount, StringFormat=N2}" Width="90"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <!-- Action Buttons -->
                    <Button Grid.Column="1" Content="📂 فتح" Command="{Binding SelectInvoiceCommand}" 
                            Background="#9B59B6" Foreground="White" Padding="12,8" Margin="5,0,0,0" VerticalAlignment="Top"/>
                    <Button Grid.Column="2" Content="🗑️ حذف" Command="{Binding DeleteInvoiceCommand}" 
                            Background="#E74C3C" Foreground="White" Padding="12,8" Margin="5,0,0,0" VerticalAlignment="Top"/>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</UserControl>